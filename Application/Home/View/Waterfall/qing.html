<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<title></title>
		<link rel="stylesheet" type="text/css" href="__PUBLIC__/Home/xuqng/qing.css"/>
		<link rel="stylesheet" href="__PUBLIC__/Home/index/css/pgwslideshow.css" />
		<link rel="stylesheet" href="__PUBLIC__/Home/css/waterfall_index.css" />
		<link rel="stylesheet" href="__PUBLIC__/Home/index/css/reset.css" />
		<script type="text/javascript" src="__PUBLIC__/jquery-1.8.2.min.js"></script>
	</head>
	<body>
		<include file="Common/alert_view_style" />
		<include file="Common/header" />
		
		<!--展示栏  开始-->
		<div class="content">
			<div class="jq22-content bgcolor-3">
				<ul class="pgwSlideshow">
					<foreach name="re['url']" item="v">
						<li><img src="__UPLOAD__{$v}" alt="" class="imag"></li>
					</foreach>
				</ul>
			</div>
			<div class="PL_an">
				<if condition="$re['p_id']">
					<button class="zoom1 fl" p_id="{$re['p_id']}">收集</button>
					<in name="re['p_id']" value="$tui">
						<button class="licke1 fr" tida="{$re['p_id']}"></button>
					<else />
						<button class="licke fr" tida="{$re['p_id']}"></button>
					</in>
				<else />
					<button class="zoom1" board_list_id="{$re['board_list_id']}">收集</button>
				</if>
			</div>
		</div>
	<!--展示栏  结束-->
	<!--评论栏   开始-->
		
		<!--<div class="PL">
			<div class="PL_1200">
				<div class="left_pl">
					
					<!--<div class="cont1">
						<div class="ren">
							<a href=""><img src="__ROOT__/{$data['member']['headimg']}" alt="" width="100%"height="100%"/></a>
							<div class="q1">
								<div style="color: #4e4d4d;font-size: 25px;">{$re['member_name']}</div>
								<div style="color: #a8a8a8;font-size: 15px;">收藏于:20分钟前</div>
							</div>
						</div>
						<div class="pl_ju">
							诗缔婚礼，让所有人都受益
						</div>
						<div class="wu">
							<span class="ss">{$re['like']}喜欢</span>
							<foreach name="re['member']" item="v">
									<div class="a1">
										<a href="" style="margin-top: -20px;">
											<img src="__ROOT__/{$v['headimg']}" alt="">
											<span style="margin-left: 15px;position: relative;top: -10px;">{$v['member_name']}</span>
										</a>
									</div>
							</foreach>
							
						</div>
					</div>-->
					<!--
				</div>
				<div class="rigth_pl">
					广告
				</div>
			</div>
		</div>	-->
		<!--评论栏   结束-->
		<!--弹框-->
		<div class="tk">
			<div class="tk_top">
				<span class="fl">转采</span>
				<a href="javascript:;" class="tk_close fr">
					<img src="__PUBLIC__/Home/img/waterfall/tk_close.png">
				</a>
			</div>
			<form class="tk_cnt clearfix" id="collect">
				<div class="tk_cnt_left">
					<img src="">
					<div class="tk_cnt_left_bj" ></div>
				</div>
				<div class="tk_cnt_right">
					<div class="tk_cnt_right_one">
						<select>
							<option></option>
						</select>
					</div>
					<div class="tk_cnt_right_two">
						<textarea name="title" ></textarea>
					</div>
				</div>
			</form>
			<div class="tk_bot">
				<a href="javascript:;" class="tk_bot_add">添加画板</a>
				<a href="#" class="tk_bot_down">采下来</a>
			</div>
		</div>
		<!--添加画板-->
		<div class="tk_add">
			<div class="tk_top">
				<span class="fl">添加画板</span>
				<a href="javascript:;" class="tk_close fr">
					<img src="__PUBLIC__/Home/img/waterfall/tk_close.png">
				</a>
			</div>
			<div class="tk_input">
				<span>名称：</span><input type="text" name="board_name" placeholder="请输入画板名称" />
			</div>
			<div class="tk_bot">
				<a href="#" class="tk_bot_down">添加画板</a>
			</div>
		</div>
		<div class="tiao">
			<div class="tiao_1200">
				该收集也在以下模块
			</div>
		</div>
		<style>
			#main{width: 1200px;margin: 0 auto;}
			.main_son{width: 240px;height: auto;float: left;}
			.pin{padding: 15px 0 0 15px;position: relative;}
			.pin_son{width: 205px;height: auto;padding: 10px;}
			.pin .box{width: 205px;height: auto;padding: 10px;background: #FFF;border: 1px solid #CCC;box-shadow: 0px 0px 6px #CCC;}
		</style>
		<div id="main">
			<div class="main_son">

			</div>
			<div class="main_son">

			</div>
			
			<div class="main_son">

			</div>
			
			<div class="main_son">

			</div>
			
			<div class="main_son">

			</div>
			<img src="__PUBLIC__/Home/img/waterfall/gif.gif" id="loading" style="margin-bottom:0;margin-left:50%;display: none;">
			<img src="__PUBLIC__/Home/img/waterfall/loading_end.png" id="ending" style="margin-bottom:0px;margin-left:50%;display: none;">
		</div>
	<script type="text/javascript" src="__PUBLIC__/Home/xuqng/js/pgwslideshow.min.js"></script>
	<script type="text/javascript" src='__PUBLIC__/Home/js/waterfall.js' defer="defer"></script>
	<!--<script type="text/javascript" src="__PUBLIC__/Home/js/masonry.js" defer="defer"></script>-->
	<script type="text/javascript">
		$(document).ready(function() {
			$('.pgwSlideshow').pgwSlideshow({
				transitionEffect:'fading',
				autoSlide:true
			});
		});
		
		window.onload = function() {

					waterfall('main', 'pin');
					var ajaxState = true;
					//定义全局变量控制,获取当前显示页数
//					no_padding_left();
					}
					var page_num = 2;
					/**
					 * 创建分屏加载
					 */
					$(window).scroll(function() {
						var page_height = $(document).height(); //是获取整个页面的高度
						var wind_height = $(window).height(); //是获取当前也就是浏览器所能看到的页面的那部分的高度
						var bottom_height = $(document).height() - $(window).height();
						var now_height = $(document).scrollTop();
						if(now_height >= bottom_height) {
							step_page();
						}
	
					});
				
					function getNum(one){
						var start = one.lastIndexOf('startmaxheight');
						var end = one.lastIndexOf('endmaxheight')-start;
						var maxheight = parseFloat(one.substr(start+14,end-14));
						var height = 0;
						var num = 0;
						for(var i = 0;i < $('.main_son').length;i++){
							if(i === 0){
								height = main_son[i];
								num = i;
							};
							if(height > main_son[i]){
								height = main_son[i];
								num = i;
							};
						};
						main_son[num] = main_son[num] + maxheight;
						return num;
					}
					//main_son初始高度
					var main_son = [];
					for(var i = 0;i < $('.main_son').length;i++){
						main_son.push(parseFloat($('.main_son').eq(i).height())); 
					};

					/**
					 * 创建异步加载分页方法
					 */
					function step_page() {
						$.ajax({
							type: "post",
							url: "{:U('home/waterfall/loading')}",
							data: {
								page_num: page_num
							},
							dataType: 'json',
							beforeSend: function() {
								$("#loading").css('display', 'block');
							},
							success: function(phpdata) {
								$.each(phpdata,function(k,v) {
									var num = getNum(v);
									$('.main_son').eq(num).append(v);
								});
							},
							complete: function() {
								$("#loading").css('display', 'none');
								ajaxState = true;
								page_num++;
							}
						});
					};
	
					/**
					 * 城市互联异步
					 */
					$(".area_omit").change(function() {
						var area_id = $("select.area_omit").val();
						$.ajax({
							type: "post",
							url: "{:U('waterfall/index')}",
							data: {
								area_id: area_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(phpdata) {
									var str = '<select style="margin-left: 8px;" class="area_city" name="area_id[]"><option>市/地区</option>';
									$.each(phpdata, function(k, v) {
										str += '<option value="' + v.area_id + '">' + v.aname + '</option>';
									});
									str += '</select>';
									$('.area_city').html(str);
								}
							}
						});
					})
	
					//点赞的ajax
					$('#main').on('click','.hide_right .click', function() {
						var board_list_id = $(this).attr('tids');
						var P_id = $(this).attr('tida');
						var This = $(this);
						$.ajax({
							type: "post",
							url: "{:U('Help/help')}",
							data: {
								board_list_id: board_list_id,
								P_id: P_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(!phpdata) {
									window.wxc.xcConfirm('您还未登录，请登录后再点赞！', window.wxc.xcConfirm.typeEnum.confirm);
								} else {
									if(phpdata.type) {
										window.wxc.xcConfirm('点赞成功', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('zan_no').addClass('zan_yes');
									} else {
										window.wxc.xcConfirm('取消点赞', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('zan_yes').addClass('zan_no');
									}
									This.parents('.pin').find('.zf_zan .zan').html(phpdata.num);
								}
	
							}
						});
					})
	
					/**
					 * 创建转载ajax
					 */
					$('#main').on('click','.hide_left a', function() {
						var p_id = $(this).attr('p_id');
						var board_list_id = $(this).attr('board_list_id');
						var This;
						$.ajax({
							type: "post",
							url: "{:U('perfect')}",
							data: {
								p_id: p_id,
								board_list_id: board_list_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(!phpdata.p_id) {
									window.wxc.xcConfirm(phpdata.content, window.wxc.xcConfirm.typeEnum.confirm);
								}else{
									var str = '<div class="tk_top"><span class="fl">转采</span><a href="javascropt:;"  class="tk_close fr"><img src="__PUBLIC__/Home/img/waterfall/tk_close.png"></a></div><form class="tk_cnt clearfix" id="collect"><div class="tk_cnt_left">';
									str += '<img src="__UPLOAD__' + phpdata.img_url[0] + '">';
									str += '<input type="hidden" name="p_id" id="p_id" value="'+phpdata.p_id+'" />';
									str += '<div class="tk_cnt_left_bj"></div></div><div class="tk_cnt_right"><div class="tk_cnt_right_one"><select name="board_id">';
									if(phpdata.board) {
										$.each(phpdata.board, function(k,v) {
											str += '<option value="'+v.board_id+'">' + v.board_name + '</option>';
										});
									} else {
										str += '<option>您还没有画板</option>';
									}
									str += '</select></div><div class="tk_cnt_right_two">';
									str += '<textarea name="title" >' + phpdata.title + '</textarea>';
									str += '</div></div></form><div class="tk_bot"><a href="#" class="tk_bot_add">添加画板</a><a href="#" class="tk_bot_down">采下来</a></div>';
									$('.tk').html(str);
									$('.tk').show();
								}
							}
						});
					});
	
					//采集图片的ajax
				$('.tk').on('click','.tk_bot_down',function() {
					var title = $('textarea[name=title]').val();
					var picture_p_id = $('input[name=p_id]').val();
					var board_id = $('select[name=board_id]').val();
					$.ajax({
						type: "post",
						url: "{:U('collect')}",
						data: {title:title,picture_p_id:picture_p_id,board_id:board_id},
						dataType: 'json',
						success: function(phpdata) {
							if(phpdata.type == 1) {
								$('.tk').hide();
									window.wxc.xcConfirm('采集完成', window.wxc.xcConfirm.typeEnum.success);
							} else {
									window.wxc.xcConfirm('采集失败', window.wxc.xcConfirm.typeEnum.error);
							}
						}
					});
				})
				$(".tk").on('click','.tk_close',function() {
					$(".tk").hide();
				})
				$(".tk").on('click','.tk_bot_add',function() {
					$(".tk_add").show();
				})
				
				//添加画板的ajax
				$('.tk_close1').click(function(){
					$('.tk_add').hide();
				})
				$(".tk_bot_down").click(function(){
					var board_name = $('input[name=board_name]').val();
					$.ajax({
						type:"post",
						url:"{:U('addboard')}",
						data:{board_name:board_name},
						dataType: 'json',
						success: function(phpdata) {
							if(phpdata){
								var str = '<div class="tk_cnt_right_one"><select name="board_id">';
								$.each(phpdata, function(k,v) {
									str += '<option value="'+v.board_id+'">' + v.board_name + '</option>';
								});
									str += '</select></div>';
									$('.tk_cnt_right_one').html(str);
									$('.tk_add').hide();
							}
						}
					});
				})
				
				
				//单独俩个按钮的ajax
				$('.zoom1').on('click', function() {
							var p_id = $(this).attr('p_id');
							var board_list_id = $(this).attr('board_list_id');
							var This;
						$.ajax({
							type: "post",
							url: "{:U('waterfall/perfect')}",
							data: {
								p_id: p_id,
								board_list_id: board_list_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(!phpdata.p_id) {
									window.wxc.xcConfirm(phpdata.content, window.wxc.xcConfirm.typeEnum.confirm);
								}else{
									var str = '<div class="tk_top"><span class="fl">转采</span><a href="javascropt:;"  class="tk_close fr"><img src="__PUBLIC__/Home/img/waterfall/tk_close.png"></a></div><form class="tk_cnt clearfix" id="collect"><div class="tk_cnt_left">';
									str += '<img src="__UPLOAD__' + phpdata.img_url[0] + '">';
									str += '<input type="hidden" name="p_id" id="p_id" value="'+phpdata.p_id+'" />';
									str += '<div class="tk_cnt_left_bj"></div></div><div class="tk_cnt_right"><div class="tk_cnt_right_one"><select name="board_id">';
									if(phpdata.board) {
										$.each(phpdata.board, function(k,v) {
											str += '<option value="'+v.board_id+'">' + v.board_name + '</option>';
										});
									} else {
										str += '<option>您还没有画板</option>';
									}
									str += '</select></div><div class="tk_cnt_right_two">';
									str += '<textarea name="title" >' + phpdata.title + '</textarea>';
									str += '</div></div></form><div class="tk_bot"><a href="#" class="tk_bot_add">添加画板</a><a href="#" class="tk_bot_down">采下来</a></div>';
									$('.tk').html(str);
									$('.tk').show();
								}
							}
						});
					});
					
					//点赞的ajax
					$('.licke').on('click', function() {
						var board_list_id = $(this).attr('tids');
						var P_id = $(this).attr('tida');
						var This = $(this);
						$.ajax({
							type: "post",
							url: "{:U('Help/help')}",
							data: {
								board_list_id: board_list_id,
								P_id: P_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(!phpdata) {
									window.wxc.xcConfirm('您还未登录，请登录后再点赞！', window.wxc.xcConfirm.typeEnum.confirm);
								} else {
									if(phpdata.type) {
										window.wxc.xcConfirm('点赞成功', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('licke').addClass('licke1');
									} else {
										window.wxc.xcConfirm('取消点赞', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('licke1').addClass('licke');
									}
									This.parents('.pin').find('.zf_zan .zan').html(phpdata.num);
								}
	
							}
						});
					})
					//点赞的ajax
					$('.licke1').on('click', function() {
						var board_list_id = $(this).attr('tids');
						var P_id = $(this).attr('tida');
						var This = $(this);
						$.ajax({
							type: "post",
							url: "{:U('Help/help')}",
							data: {
								board_list_id: board_list_id,
								P_id: P_id
							},
							dataType: 'json',
							success: function(phpdata) {
								if(!phpdata) {
									window.wxc.xcConfirm('您还未登录，请登录后再点赞！', window.wxc.xcConfirm.typeEnum.confirm);
								} else {
									if(phpdata.type) {
										window.wxc.xcConfirm('点赞成功', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('licke').addClass('licke1');
									} else {
										window.wxc.xcConfirm('取消点赞', window.wxc.xcConfirm.typeEnum.success);
										This.removeClass('licke1').addClass('licke');
									}
									This.parents('.pin').find('.zf_zan .zan').html(phpdata.num);
								}
	
							}
						});
					})
		</script>
	</body>
</html>
